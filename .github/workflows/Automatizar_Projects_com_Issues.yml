name: GitHub Projects Automation

on:
  issues:
    types: [opened, edited, closed]

jobs:
  update-projects:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Handle issues in Projects V2
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PROJECT_TOKEN }}
          script: |            
            (async () => {
              try {
                const owner = context.repo.owner;
                const repo = context.repo.repo;
                const issueNumber = context.issue.number;
            
                // -----------------------------
                // CONFIGURAÇÃO: IDs do projeto
                // -----------------------------
                const PROJECT_ID        = "PVT_kwHOCkTTTs4BCts3";      // node id do Project V2 (PNI_...)
                const STATUS_FIELD_ID   = "PVTSSF_lAHOCkTTTs4BCts3zg02C_4"; // node id do campo Status (PVTSSF_... ou similar)
                const OPTION_BACKLOG_ID = "f75ad846";   // option id para "Backlog"
                const OPTION_READY_ID   = "61e4505c";     // option id para "Ready"
                const OPTION_DONE_ID    = "98236657";      // option id para "Done"
            
                // -----------------------------
                // 1) Buscar dados do issue
                // -----------------------------
                const issueQuery = `
                  query($owner:String!, $repo:String!, $number:Int!) {
                    repository(owner:$owner, name:$repo) {
                      issue(number:$number) {
                        id
                        number
                        title
                        state
                        labels(first:20){ nodes{ name } }
                        trackedIssues(first:50) { nodes { number state id } }
                      }
                    }
                  }`;
            
                const iq = await github.graphql(issueQuery, { owner, repo, number: issueNumber });
                const issue = iq.repository.issue;
                const labels = (issue.labels.nodes || []).map(n => n.name);
            
                // -----------------------------
                // 2) Paginar todos os itens do projeto
                // -----------------------------
                async function getAllProjectItems(projectId) {
                  let allItems = [];
                  let cursor = null;
            
                  do {
                    const query = `
                      query($projectId: ID!, $first: Int!, $after: String) {
                        node(id:$projectId) {
                          ... on ProjectV2 {
                            items(first:$first, after:$after) {
                              pageInfo { hasNextPage endCursor }
                              nodes {
                                id
                                content { ... on Issue { number id state } }
                              }
                            }
                          }
                        }
                      }`;
                    const res = await github.graphql(query, { projectId, first: 100, after: cursor });
                    const items = res.node.items.nodes || [];
                    allItems = allItems.concat(items);
                    cursor = res.node.items.pageInfo.hasNextPage ? res.node.items.pageInfo.endCursor : null;
                  } while (cursor);
            
                  return allItems;
                }
            
                // -----------------------------
                // 3) Procurar item do project para o issue
                // -----------------------------
                async function findProjectItemForIssue() {
                  const allItems = await getAllProjectItems(PROJECT_ID);
                  const found = allItems.find(it => it.content && it.content.number === issue.number);
                  return found ? found.id : null;
                }
            
                // -----------------------------
                // 4) Adicionar issue ao project
                // -----------------------------
                async function addIssueToProject() {
                  try {
                    const addMutation = `
                      mutation($projectId: ID!, $contentId: ID!) {
                        addProjectV2ItemById(input: { projectId: $projectId, contentId: $contentId }) {
                          item { id }
                        }
                      }`;
                    const add = await github.graphql(addMutation, { projectId: PROJECT_ID, contentId: issue.id });
                    return add.addProjectV2ItemById.item.id;
                  } catch (e) {
                    return await findProjectItemForIssue();
                  }
                }
            
                // -----------------------------
                // 5) Atualizar campo Status do item
                // -----------------------------
                async function setStatus(projectItemId, optionId) {
                  const mutation = `
                    mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $optionId: String!) {
                      updateProjectV2ItemFieldValue(input: {
                        projectId: $projectId,
                        itemId: $itemId,
                        fieldId: $fieldId,
                        value: { singleSelectOptionId: $optionId }
                      }) {
                        projectV2Item { id }
                      }
                    }`;
                  await github.graphql(mutation, {
                    projectId: PROJECT_ID,
                    itemId: projectItemId,
                    fieldId: STATUS_FIELD_ID,
                    optionId
                  });
                }
            
                // -----------------------------
                // 6) Lógica principal
                // -----------------------------
                let projectItemId = await findProjectItemForIssue();
                if (!projectItemId) projectItemId = await addIssueToProject();
                if (!projectItemId) {
                  console.log(`Não foi possível obter project item para issue #${issue.number}.`);
                  return;
                }
            
                if (labels.includes('task')) {
                  console.log(`Issue #${issue.number} tem label task → adicionando e setando Ready`);
                  await setStatus(projectItemId, OPTION_READY_ID);
                  return;
                }
            
                if (labels.includes('user-story')) {
                  console.log(`Issue #${issue.number} é user-story → adicionando e setando Backlog`);
                  const tracked = issue.trackedIssues.nodes || [];
                  const openTracked = tracked.filter(si => si.state === "OPEN");
                  await setStatus(projectItemId, OPTION_BACKLOG_ID);
            
                  if (tracked.length > 0 && openTracked.length === 0) {
                    console.log(`Todas sub-issues fechadas → setando Done`);
                    await setStatus(projectItemId, OPTION_DONE_ID);
                  } else {
                    console.log(`User-story tem ${openTracked.length} sub-issues abertas.`);
                  }
                  return;
                }
            
                console.log(`Issue #${issue.number} não tem label task nem user-story → nada a fazer.`);
            
              } catch (err) {
                console.log("Erro no script:", err);
                throw err;
              }
            })();
